#!/bin/bash
# Takes an optional argument for a root directory builds callgraph for all APKs in current directory or subdirectories
# Requires Androguard to be installed
# See info on the androguard cg command at https://androguard.readthedocs.io/en/latest/tools/androcg.html
# See info on my attempt at BASH concurrency at https://unix.stackexchange.com/questions/103920/parallelize-a-bash-for-loop

generateGML () {
    local sourcePath=$1
    gmlPath=${sourcePath%.*}.gml
    if [ -f $gmlPath ]; then
        echo "$gmlPath already exists! Skipping"
    else 
        echo "Starting $gmlPath"
        androguard --quiet cg $sourcePath -o $gmlPath
        echo "Finished $gmlPath"
    fi

}

for apkPath in `find ${1:-'.'} -name "*.apk" -type f`; do
    generateGML "$apkPath" & 
done
wait